import{r as T,o as ae,_ as le,L as Q,w as ue,z as G,c as d,M as y,g as l,f as u,j as g,I as j,e as L,d as U,N as ce,O as pe,H as _e,P as $,n as q,Q as de,ab as fe,a as he,R as me,S as R,G as h,T as P,l as ge,m as ye,E as ve}from"./index-cc90a63c.js";import{E as be}from"./el-pagination-1b5bba26.js";import{E as we,a as Ee}from"./el-table-column-25359a9a.js";import"./el-select-ba1a1082.js";import{E as Ce,a as Te}from"./el-col-6d2c95f1.js";import{d as xe,g as Oe,a as Le}from"./api-d0f29115.js";import{u as De}from"./page-7fea1619.js";import{E as A}from"./index-12cbd309.js";import{v as Se}from"./directive-9d3e2d96.js";import{E as ke}from"./index-2c9c9e7e.js";/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var W=function(t,e){return W=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,r){n.__proto__=r}||function(n,r){for(var o in r)r.hasOwnProperty(o)&&(n[o]=r[o])},W(t,e)};function H(t,e){W(t,e);function n(){this.constructor=t}t.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}function Ne(t){var e=typeof Symbol=="function"&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function Me(t,e){var n=typeof Symbol=="function"&&t[Symbol.iterator];if(!n)return t;var r=n.call(t),o,s=[],i;try{for(;(e===void 0||e-- >0)&&!(o=r.next()).done;)s.push(o.value)}catch(c){i={error:c}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}return s}function Re(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(Me(arguments[e]));return t}var J=function(){function t(e,n){this.target=n,this.type=e}return t}(),Pe=function(t){H(e,t);function e(n,r){var o=t.call(this,"error",r)||this;return o.message=n.message,o.error=n,o}return e}(J),je=function(t){H(e,t);function e(n,r,o){n===void 0&&(n=1e3),r===void 0&&(r="");var s=t.call(this,"close",o)||this;return s.wasClean=!0,s.code=n,s.reason=r,s}return e}(J);/*!
 * Reconnecting WebSocket
 * by Pedro Ladaria <pedro.ladaria@gmail.com>
 * https://github.com/pladaria/reconnecting-websocket
 * License MIT
 */var Ie=function(){if(typeof WebSocket<"u")return WebSocket},ze=function(t){return typeof t<"u"&&!!t&&t.CLOSING===2},C={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+Math.random()*4e3,minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1},Ge=function(){function t(e,n,r){var o=this;r===void 0&&(r={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(s){o._debug("open event");var i=o._options.minUptime,c=i===void 0?C.minUptime:i;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout(function(){return o._acceptOpen()},c),o._ws.binaryType=o._binaryType,o._messageQueue.forEach(function(a){return o._ws.send(a)}),o._messageQueue=[],o.onopen&&o.onopen(s),o._listeners.open.forEach(function(a){return o._callEventListener(s,a)})},this._handleMessage=function(s){o._debug("message event"),o.onmessage&&o.onmessage(s),o._listeners.message.forEach(function(i){return o._callEventListener(s,i)})},this._handleError=function(s){o._debug("error event",s.message),o._disconnect(void 0,s.message==="TIMEOUT"?"timeout":void 0),o.onerror&&o.onerror(s),o._debug("exec error listeners"),o._listeners.error.forEach(function(i){return o._callEventListener(s,i)}),o._connect()},this._handleClose=function(s){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(s),o._listeners.close.forEach(function(i){return o._callEventListener(s,i)})},this._url=e,this._protocols=n,this._options=r,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(t,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(t,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(t,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"CONNECTING",{get:function(){return t.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"OPEN",{get:function(){return t.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"CLOSING",{get:function(){return t.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"CLOSED",{get:function(){return t.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bufferedAmount",{get:function(){var e=this._messageQueue.reduce(function(n,r){return typeof r=="string"?n+=r.length:r instanceof Blob?n+=r.size:n+=r.byteLength,n},0);return e+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?t.CLOSED:t.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),t.prototype.close=function(e,n){if(e===void 0&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),!this._ws){this._debug("close enqueued: no ws instance");return}if(this._ws.readyState===this.CLOSED){this._debug("close: already closed");return}this._ws.close(e,n)},t.prototype.reconnect=function(e,n){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,!this._ws||this._ws.readyState===this.CLOSED?this._connect():(this._disconnect(e,n),this._connect())},t.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var n=this._options.maxEnqueuedMessages,r=n===void 0?C.maxEnqueuedMessages:n;this._messageQueue.length<r&&(this._debug("enqueue",e),this._messageQueue.push(e))}},t.prototype.addEventListener=function(e,n){this._listeners[e]&&this._listeners[e].push(n)},t.prototype.dispatchEvent=function(e){var n,r,o=this._listeners[e.type];if(o)try{for(var s=Ne(o),i=s.next();!i.done;i=s.next()){var c=i.value;this._callEventListener(e,c)}}catch(a){n={error:a}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return!0},t.prototype.removeEventListener=function(e,n){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(r){return r!==n}))},t.prototype._debug=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this._options.debug&&console.log.apply(console,Re(["RWS>"],e))},t.prototype._getNextDelay=function(){var e=this._options,n=e.reconnectionDelayGrowFactor,r=n===void 0?C.reconnectionDelayGrowFactor:n,o=e.minReconnectionDelay,s=o===void 0?C.minReconnectionDelay:o,i=e.maxReconnectionDelay,c=i===void 0?C.maxReconnectionDelay:i,a=0;return this._retryCount>0&&(a=s*Math.pow(r,this._retryCount-1),a>c&&(a=c)),this._debug("next delay",a),a},t.prototype._wait=function(){var e=this;return new Promise(function(n){setTimeout(n,e._getNextDelay())})},t.prototype._getNextUrl=function(e){if(typeof e=="string")return Promise.resolve(e);if(typeof e=="function"){var n=e();if(typeof n=="string")return Promise.resolve(n);if(n.then)return n}throw Error("Invalid URL")},t.prototype._connect=function(){var e=this;if(!(this._connectLock||!this._shouldReconnect)){this._connectLock=!0;var n=this._options,r=n.maxRetries,o=r===void 0?C.maxRetries:r,s=n.connectionTimeout,i=s===void 0?C.connectionTimeout:s,c=n.WebSocket,a=c===void 0?Ie():c;if(this._retryCount>=o){this._debug("max retries reached",this._retryCount,">=",o);return}if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),!ze(a))throw Error("No valid WebSocket class provided");this._wait().then(function(){return e._getNextUrl(e._url)}).then(function(w){e._closeCalled||(e._debug("connect",{url:w,protocols:e._protocols}),e._ws=e._protocols?new a(w,e._protocols):new a(w),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout(function(){return e._handleTimeout()},i))})}},t.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new Pe(Error("TIMEOUT"),this))},t.prototype._disconnect=function(e,n){if(e===void 0&&(e=1e3),this._clearTimeouts(),!!this._ws){this._removeListeners();try{this._ws.close(e,n),this._handleClose(new je(e,n,this))}catch{}}},t.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},t.prototype._callEventListener=function(e,n){"handleEvent"in n?n.handleEvent(e):n(e)},t.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},t.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},t.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},t}();const v=T(null),I=T(new Map),K=T(new Map),x=new Map;x.set("log_change",[]);x.set("status_change",[]);function F(t,e){x.has(t)&&x.get(t).push(e)}function X(t="ws://127.0.0.1:8888/websocket"){return ae(()=>{v.value==null&&(v.value=new Ge(t),v.value.onmessage=Ue,v.value.onopen=We,v.value.onerror=Fe,v.value.onclose=Ve)}),{websocketTarget:v,logMessage:I,statusMessage:K}}const Ue=t=>{if(t.data=="pong")return;const e=JSON.parse(t.data);e.msgType=="log_change"&&x.get("log_change").map(n=>n(e.data)),e.msgType=="status_change"&&x.get("status_change").map(n=>n(e.data))},We=t=>{var e=setInterval(()=>{v.value.readyState==1?v.value.send("ping"):clearInterval(e)},5e3)},Fe=t=>{console.log("onError",t)},Ve=t=>{console.log("onClose",t)};F("log_change",t=>{t.map(e=>{I.value.has(e.id)||I.value.set(e.id,[]),I.value.get(e.id).push(e)})});F("status_change",t=>{K.value.set(t.pid,t.status)});const Be={__name:"do-deploy",props:{visible:{type:Boolean},visibleModifiers:{},formData:{type:Object},formDataModifiers:{}},emits:["update:visible","update:formData"],setup(t){const{logMessage:e,statusMessage:n}=X(),r=Q(t,"visible"),o=Q(t,"formData"),s=T();ue(e,async()=>{await _e(),s.value.scrollTop=s.value.scrollHeight},{deep:!0});const i=G(()=>e.value.get(o.value.id)),c=G(()=>n.value.get(o.value.id)),a=G(()=>{switch(n.value.get(o.value.id)){case 0:return{text:"上线",type:"primary"};case 1:return{text:"上线中",type:"default"};case 2:return{text:"重新上线",type:"success"};case 3:return{text:"重新上线",type:"warning"}}return{}}),w=async()=>{c.value!=0&&await A.confirm("是否重新上线","警告"),await xe(o.value.id),r.value=!1,$.success("成功")},D=S=>{switch(S){case 0:return"gray";case 1:return"green";case 2:return"yellow";case 3:return"red"}return"green"};return(S,b)=>{const k=q,O=de;return d(),y(O,{title:"发布项目/"+o.value.deployName,modelValue:r.value,"onUpdate:modelValue":b[2]||(b[2]=_=>r.value=_),"close-on-click-modal":!1,width:"50%"},{footer:l(()=>[u(k,{onClick:b[0]||(b[0]=_=>r.value=!1)},{default:l(()=>[g("关 闭")]),_:1}),u(k,{type:a.value.type,onClick:b[1]||(b[1]=_=>w()),loading:c.value==1},{default:l(()=>[g(j(a.value.text),1)]),_:1},8,["type","loading"])]),default:l(()=>[L("div",{class:"message-box",ref_key:"messageInnerRef",ref:s},[(d(!0),U(pe,null,ce(i.value,_=>(d(),U("div",{class:"message-text",key:_},[L("pre",{style:fe({color:D(_.type)})},j(_.createTime)+" "+j(_.message),5)]))),128))],512)]),_:1},8,["title","modelValue"])}}},Qe=le(Be,[["__scopeId","data-v-ce00b50c"]]),$e={class:"app-container"},qe=L("p",{class:"page-title"},"上线单列表",-1),Ae={class:"filter-container"},He={class:"page-container"},st={__name:"index",setup(t){const e=he(),{websocketTarget:n,logMessage:r,statusMessage:o}=X(),s=async()=>{i.value=!0;const{data:f}=await Oe(a.value);c.value=f.data,D.value=f.total,i.value=!1};F("status_change",s);const{tableLoading:i,list:c,params:a,pageSizes:w,total:D,handleSizeChange:S,handleCurrentChange:b}=De(s),k=()=>{e.push("/deploy/add")},O=T(!1),_=T({}),Y=async f=>{O.value=!0,_.value=f,o.value.set(f.id,f.status),r.value.has(f.id)||n.value.send(`{"msgType":"init","data":${f.id}}`)},Z=async f=>{await A.confirm("删除上线单不可恢复","警告");const{message:m}=await Le(f.id);$.success(m),s()};return(f,m)=>{const N=q,V=Te,ee=ge,B=ye,te=ve,ne=Ce,E=Ee,M=ke,oe=we,re=be,z=me("permission"),se=Se;return d(),U("div",$e,[qe,L("div",Ae,[u(ne,{gutter:20,justify:"space-between"},{default:l(()=>[u(V,{span:6},{default:l(()=>[R((d(),y(N,{type:"primary",size:"default",plain:"",onClick:m[0]||(m[0]=p=>k())},{default:l(()=>[g(" 新建上线单 ")]),_:1})),[[z,"deploy:add"]])]),_:1}),u(V,{span:18},{default:l(()=>[u(te,{ref:"queryFormRef",inline:"",style:{float:"right"},size:"default",model:h(a)},{default:l(()=>[u(B,{label:"上线单",prop:"name"},{default:l(()=>[u(ee,{modelValue:h(a).name,"onUpdate:modelValue":m[1]||(m[1]=p=>h(a).name=p),clearable:""},null,8,["modelValue"])]),_:1}),u(B,null,{default:l(()=>[u(N,{type:"primary",onClick:s},{default:l(()=>[g("查询")]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1})]),R((d(),y(oe,{"element-loading-text":"加载中...",border:"",data:h(c)},{default:l(()=>[u(E,{label:"ID",prop:"id",align:"center",width:"60px"}),u(E,{align:"center",label:"上线单","show-overflow-tooltip":"",prop:"deployName"}),u(E,{align:"center",label:"上线项目","show-overflow-tooltip":"",prop:"projectName"}),u(E,{align:"center",label:"使用模板","show-overflow-tooltip":"",prop:"templateName"}),u(E,{align:"center",label:"更新时间",width:"180px",prop:"updateTime"}),u(E,{align:"center",label:"状态",width:"100px",prop:"status"},{default:l(({row:p})=>[p.status==0?(d(),y(M,{key:0,type:"warning"},{default:l(()=>[g("待上线")]),_:1})):P("",!0),p.status==1?(d(),y(M,{key:1,type:"primary"},{default:l(()=>[g("上线中")]),_:1})):P("",!0),p.status==2?(d(),y(M,{key:2,type:"success"},{default:l(()=>[g("上线成功")]),_:1})):P("",!0),p.status==3?(d(),y(M,{key:3,type:"danger"},{default:l(()=>[g("上线失败")]),_:1})):P("",!0)]),_:1}),u(E,{align:"center",width:"170px",label:"操作"},{default:l(({row:p})=>[R((d(),y(N,{size:"small",loading:p.status==1,type:"primary",onClick:ie=>Y(p)},{default:l(()=>[g(j(p.status==2?"查看":"上线"),1)]),_:2},1032,["loading","onClick"])),[[z,"deploy:deploy"]]),R((d(),y(N,{size:"small",type:"danger",onClick:ie=>Z(p)},{default:l(()=>[g(" 删除 ")]),_:2},1032,["onClick"])),[[z,"deploy:del"]])]),_:1})]),_:1},8,["data"])),[[se,h(i)]]),L("div",He,[u(re,{background:"","current-page":h(a).page,"page-sizes":h(w),"page-size":h(a).pageSize,layout:"total, sizes, prev, pager, next, jumper",total:h(D),onSizeChange:h(S),onCurrentChange:h(b)},null,8,["current-page","page-sizes","page-size","total","onSizeChange","onCurrentChange"])]),u(Qe,{visible:O.value,"onUpdate:visible":m[2]||(m[2]=p=>O.value=p),formData:_.value,"onUpdate:formData":m[3]||(m[3]=p=>_.value=p)},null,8,["visible","formData"])])}}};export{st as default};
